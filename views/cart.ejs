<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - GamerVision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #e0e0e0; }
        .text-accent { color: #ff6b00; }
        .bg-accent { background-color: #ff6b00; }
        .qty-input { background-color: #1a1a1a; border: 1px solid #333; color: white; text-align: center; appearance: textfield; }
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .qty-btn { background-color: #252525; color: #fff; border: 1px solid #333; transition: all 0.2s; }
        .qty-btn:hover { background-color: #ff6b00; border-color: #ff6b00; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-[#1a1a1a] border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/home" class="flex items-center gap-2 flex-shrink-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-black font-bold text-xl">G</div>
                <div class="flex flex-col"><span class="text-2xl font-black tracking-tighter text-white">GAMER<span class="text-[#ff6b00]">VISIÓN</span></span></div>
            </a>
            <div class="flex items-center gap-6">
                <!-- ICONO SALIR (CORREGIDO) -->
                <a href="/auth/logout" class="text-gray-300 hover:text-red-500 transition flex flex-col items-center" title="Salir">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </a>
                <div class="relative">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-[#ff6b00]"></i>
                    <span class="absolute -top-2 -right-2 bg-white text-black text-[10px] font-bold px-1.5 py-0.5 rounded-full"><%= carrito ? carrito.length : 0 %></span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 py-10">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-black text-white mb-8 uppercase tracking-wider border-l-4 border-[#ff6b00] pl-4">Tu Carrito</h1>

            <% if (!carrito || carrito.length === 0) { %>
                <div class="text-center py-20 bg-[#1a1a1a] rounded-lg border border-gray-800">
                    <i data-lucide="shopping-cart" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-400">Tu carrito está vacío</h2>
                    <a href="/tienda" class="bg-[#ff6b00] text-white px-6 py-3 rounded font-bold hover:bg-[#e65100] transition mt-4 inline-block">IR A LA TIENDA</a>
                </div>
            <% } else { %>

            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-1">
                    <div class="hidden md:grid grid-cols-12 gap-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-800 pb-3 mb-4">
                        <div class="col-span-6">Producto</div>
                        <div class="col-span-2 text-center">Precio</div>
                        <div class="col-span-2 text-center">Cantidad</div>
                        <div class="col-span-2 text-right">Subtotal</div>
                    </div>

                    <% let totalGeneral = 0; %>
                    <% carrito.forEach(item => { %>
                        <% let subtotal = item.producto.precio * item.cantidad; %>
                        <% totalGeneral += subtotal; %>
                        <div class="bg-[#1a1a1a] rounded-lg p-4 mb-4 border border-gray-800 flex flex-col md:grid md:grid-cols-12 gap-4 items-center relative group">
                            
                            <!-- Eliminar -->
                            <form action="/carrito/eliminar" method="POST" class="absolute top-2 right-2 md:top-auto md:right-auto md:-left-3 md:relative">
                                <input type="hidden" name="productoId" value="<%= item.producto._id %>">
                                <button type="submit" class="text-gray-500 hover:text-red-500 transition"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                            </form>

                            <!-- Info -->
                            <div class="col-span-6 flex items-center gap-4 w-full">
                                <div class="w-20 h-20 bg-white rounded p-2 flex-shrink-0 flex items-center justify-center">
                                    <img src="<%= item.producto.imagen %>" class="object-contain h-full">
                                </div>
                                <div><h3 class="font-bold text-white text-sm md:text-base"><%= item.producto.nombre %></h3></div>
                            </div>

                            <!-- Precio -->
                            <div class="col-span-2 text-center w-full flex justify-between md:block px-4 md:px-0">
                                <span class="md:hidden text-gray-500 text-sm">Precio:</span><span class="text-gray-300">$<%= item.producto.precio %></span>
                            </div>

                            <!-- Cantidad (FORMULARIO FUNCIONAL) -->
                            <div class="col-span-2 flex justify-center w-full md:w-auto px-4 md:px-0 mt-2 md:mt-0">
                                <form action="/carrito/actualizar" method="POST" class="flex items-center">
                                    <input type="hidden" name="productoId" value="<%= item.producto._id %>">
                                    <button type="submit" name="accion" value="restar" class="qty-btn w-8 h-8 rounded-l flex items-center justify-center">-</button>
                                    <input type="number" value="<%= item.cantidad %>" class="qty-input w-12 h-8 text-sm focus:outline-none" readonly>
                                    <button type="submit" name="accion" value="sumar" class="qty-btn w-8 h-8 rounded-r flex items-center justify-center">+</button>
                                </form>
                            </div>

                            <!-- Subtotal -->
                            <div class="col-span-2 text-right w-full flex justify-between md:block px-4 md:px-0 mt-2 md:mt-0 border-t border-gray-800 pt-2 md:border-0 md:pt-0">
                                <span class="md:hidden text-gray-500 text-sm font-bold">Total:</span><span class="text-[#ff6b00] font-bold text-lg">$<%= subtotal.toFixed(2) %></span>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <!-- TOTALES -->
                <div class="w-full lg:w-1/3">
                    <div class="bg-[#1a1a1a] rounded-lg border border-gray-800 p-6 sticky top-24">
                        <h2 class="text-xl font-bold text-white mb-6 border-b border-gray-800 pb-4">TOTAL</h2>
                        <div class="border-t border-gray-800 pt-4 mb-6 flex justify-between items-end"><span class="text-white font-bold">TOTAL</span><span class="text-2xl font-black text-[#ff6b00]">$<%= totalGeneral.toFixed(2) %></span></div>
                        <button class="w-full bg-[#ff6b00] hover:bg-[#e65100] text-white font-bold py-4 rounded transition transform hover:scale-[1.02] shadow-lg shadow-orange-900/20 mb-3" onclick="alert('¡Compra simulada con éxito!')">FINALIZAR COMPRA</button>
                        <a href="/tienda" class="block text-center text-sm text-gray-500 hover:text-white transition underline">Continuar Comprando</a>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
    </main>

    <footer class="bg-[#0a0a0a] border-t border-gray-800 py-8 mt-auto"><div class="container mx-auto px-4 text-center"><p class="text-xs text-gray-600">© 2024 NomadaWare Clon.</p></div></footer>
    <script>lucide.createIcons();</script>
</body>
</html>